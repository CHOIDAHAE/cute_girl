<html lang="ko">
	<head>
		<meta charset="utf-8">
		<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
		<!--<script  src="http://code.jquery.com/jquery-latest.min.js"></script>-->
		<script src="https://kit.fontawesome.com/ad41bee873.js" crossorigin="anonymous"></script>
		<link href="../css/style.css?after" rel="stylesheet" type="text/css">
		<link href="../css/menu.css?after" rel="stylesheet" type="text/css">
		<link href="../css/grid.css?after" rel="stylesheet" type="text/css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" crossorigin="anonymous" />

		<script>
			window.onload = function(){
				file_Volume();	// 파일 용량 조회
				fileSelect("Y", "ALL");	// 파일 조회
				closeModal();	//모임만들기 모달 닫기
				document.getElementById('void_btn').disabled = true;

				//우클릭 메뉴 숨기기
				$(document).click(function(){
					$('#gridArea').contents().find(".contextmenu").hide();
				})
			};

			//파일용량 읽어오기
			function file_Volume(){
				var emplyrSn = $('#emplyrSn').val();

				$.ajax({
					url : "/selectFileVolume",
					type : "POST",
					dataType : "JSON", //"JSON"
					data : {"emplyrSn" : emplyrSn}
				})
				.done(function (res) {
					$("#capacity").text(res[0][0]);        // 사용중 용량
					$("#rest_capacity").text(res[0][3]);   // 남은 용량

					var bar = document.getElementById('bar');
					bar.style.width = res[0][0]/10+'%';           // graph color control = 남은용량 퍼센트
				})
				.fail(function (xhr, textStatus, errorThrown) {
					console.log('selectFileVolume ajax 실패');
				})
			};
			
			/* 정렬기준 변경 이벤트 */
			function selectNayeol(){
				var sortSelect = document.getElementById("sortSbBox");
				var selectValue = sortSelect.options[sortSelect.selectedIndex].value;
				var selectText = sortSelect.options[sortSelect.selectedIndex].text;

				var fileType = $('#gridArea').contents().find('#fileTypeNm').attr('value');

				fileSelect("Y", fileType, selectValue);
			};

			function openMenu(menuNm){
				var gridArea = document.getElementById("gridArea");
				
				document.getElementById("gridArea").src = menuNm;
			};
			
			// 대메뉴, 소메뉴 선택시 클래스 삭제
			function unselected(gbn){
				/* 
				 * 대메뉴 id 명명규칙 : dMenu0, dMenu1..
				 * 소메뉴 id 명명규칙 : sMenu00, sMenu01 (대메뉴 dMenu0아래의 소메뉴) / sMenu10, sMenu11 (대메뉴 dMenu1아래의 소메뉴)
				*/
				// 하드코딩, 메뉴 코드관리?
				for( var i=0; i<4; i++){    //대메뉴 4개
						document.getElementById('dMenu'+i).classList.remove('selected');
					}

				for( var i=0; i<4; i++){    //소메뉴(모든파일) 4개
					document.getElementById('sMenu0'+i).classList.remove('selected');
				}

				for( var i=0; i<1; i++){    //소메뉴(내 그룹) 2개
					document.getElementById('sMenu3'+i).classList.remove('selected');
				}
			};

			// 대메뉴, 소메뉴 선택시 클래스 추가
			function selected(menuId){
				document.getElementById(menuId).classList.add('selected');
			};

			/* 파일 업로드 */
			function fileUpload(){
				// debugger;
				var formData = new FormData();
				formData.append('attachment', $('#fileUpload')[0].files[0]);

				$.ajax({
					url : '/uploadFile',
					type:"POST",
					processData : false,
					contentType : false,
					async : false,
					enctype: 'multipart/form-data',
					dataType : "JSON",
					data : formData,
					success:function(result){
						//확장자가 exe일 경우 업로드 제한
						if(result == "exe"){
							alert("exe 파일은 업로드할 수 없습니다!");
						}else{
							alert("업로드가 완료되었습니다.");
						}
						// if ($.browser.msie) {
							// ie 일때 input[type=file] init.
							// $("#fileUpload").replaceWith( $("#filename").clone(true) );
						// } else {
							// other browser 일때 input[type=file] init.
							$("#fileUpload").val("");
							fileSelect("Y", "ALL");
							file_Volume();
						// }
					},
					error:function(e){
						console.log('fileUpload ajax error');
						console.log(e);
					}
				});
			};

			// 파일 조회 
			function fileSelect(useAt, fileType, sortType){
				//기존 조회에서 파일 정리하기 메뉴 숨기기
				$('#gridArea').contents().find('#clean_file_menu').hide();
				var emplyrSn = document.getElementById('emplyrSn').value;
				
				//iframe 주소가 main이 아닐 경우 수정해주기
				if($('#gridArea').attr('src') != '/main'){
					openMenu('main');
				}
				
				//정렬 기준
				var orderBy = "NULL";

				if(sortType == "name"){
					orderBy = "fileNm";
				}else if(sortType == "date"){
					orderBy == "date";
				}

				$.ajax({
					url : "/selectFileList",
					type : "POST",
					dataType : "JSON", //"JSON"
					data : {"emplyrSn" : emplyrSn, "useAt" : useAt, "fileType" : fileType, "orderBy" : orderBy}
				})
				.done(function (res) {
					var fileArea = $('#gridArea').contents().find('#fileList');	//파일목록
					var ListType = $('#gridArea').contents().find('#ListType');	//조회타입
					var fileTypeNm = $('#gridArea').contents().find('#fileTypeNm');	//파일타입 (하단 메뉴 선택시)

					var fileList = "";

					for(var i=0; i<res.length; i++){
						//파일타입이 사진이 아닐 경우 아이콘으로 보여주기
						var extsnNm = res[i][11].split("/")[0];
						var fileSrc = "../uploadedFiles/" + res[i][1];
						if(extsnNm != "image"){
							fileSrc = "../images/Icon_" + res[i][3] + ".png";
						}

						fileList += '<li class="item_fnc" id="' + res[i][8]+ '" onclick="view_photoInfo(this)">';
						/* ID : IMG_파일일련번호_즐겨찾기추가여부_사용여부 */
						fileList += '<img src="' + fileSrc + '" id="img_' + res[i][8] + '_' + res[i][9] + '_' + res[i][10] + '" class="img_item"/>\n';
						fileList += '<div class="item-name" id="dv_' + res[i][8] + '"> ' + res[i][2] + ' </div>\n';	//파일명
						fileList += '<input type="hidden" id="orgFileNm_' + res[i][8] + '" value="' + res[i][1] + '"></li>\n';						//원본파일명
					}

					$(fileArea).html(fileList);      //파일 리스트
					$(ListType).attr('value', "selectList");	//조회타입 설정
					$(fileTypeNm).attr('value', fileType);		//파일타입 설정
				})
				.fail(function (xhr, textStatus, errorThrown) {
					console.log('selectFileList ajax 실패');
					console.log('xhr'+xhr);
					console.log('textStatus'+textStatus);
					console.log('errorThrown'+errorThrown);
				})
			};

			// 환경설정 팝업
			function openWindowPop(url, name){
				var options = 'top=100, left=650, width=790, height=635, status=no, menubar=no, toolbar=no, resizable=no';
				window.open(url, name, options);
			};

			/* 즐겨찾기 조회 */
			function selectBkmk(){
				$('#gridArea').contents().find('#clean_file_menu').hide();
				var emplyrSn = document.getElementById('emplyrSn').value;

				$.ajax({
					url : "/selectBkmkList",
					type : "POST",
					dataType : "JSON", //"JSON"
					data : {"emplyrSn" : emplyrSn}

				})
				.done(function (res) {
					var fileArea = $('#gridArea').contents().find('#fileList');
					var ListType = $('#gridArea').contents().find('#ListType');
					var fileTypeNm = $('#gridArea').contents().find('#fileTypeNm');
					
					var fileList = "";

					for(var i=0; i<res.length; i++){
						var extsnNm = res[i][6].split("/")[0];
						var fileSrc = "../uploadedFiles/" + res[i][2];
						if(extsnNm != "image"){
							fileSrc = "../images/Icon_" + res[i][4] + ".png";
						}

						fileList += '<li class="item_fnc" id="' + res[i][0] + '" onclick="view_photoInfo(this)">';
						fileList += '<img src="' + fileSrc + '" id="img_' + res[i][0] + '_Y_Y" class="img_item"/>\n';
						fileList += '<div class="item-name" id="dv_' + res[i][0] + '"> ' + res[i][5] + ' </div>\n';
						fileList += '<input type="hidden" id="orgFileNm_' + res[i][0] + '" value="' + res[i][2] + '"></li>\n';	//원본파일명
					}

					$(fileArea).html(fileList);      //파일 리스트
					$(ListType).attr('value', "selectList");	//조회타입 설정
					$(fileTypeNm).attr('value', "ALL");		//파일타입 설정
				})
				.fail(function (xhr, textStatus, errorThrown) {
					console.log('selectBkmkList ajax 실패');
					console.log('xhr'+xhr);
					console.log('textStatus'+textStatus);
					console.log('errorThrown'+errorThrown);
				})
			};

			//파일정리하기
			function cleanUpFiles(){
				$('#gridArea').contents().find('#clean_file_menu').show();
				$('#gridArea').contents().find('#fileNmDup').click();
				$('#gridArea').contents().find('#fileNmDupLi').toggleClass('cleanMenuSelected');
			}
				
			// 모임만들기 모달 열기
			function openModal() {
				$('.modal_wrap').show();
				$('.next_modal').hide();
			};

			// 모임만들기 모달 닫기
			function closeModal() {
				$('.modal_wrap').hide();
				$('.next_modal').hide();
				document.getElementById('input_group').value = "";
				
				// 메뉴 selected 없애기
				document.getElementById('sMenu30').classList.remove('selected');
			};

			// 모임만들기 완료 모달 열기
			function nextModal(){
				$('.modal_wrap').hide();

				var emplyrSn = $('#emplyrSn').val();
				var groupNm = $('#input_group').val();

				// 이 시점에서 그룹을 만든다.
				$.ajax({
					url : "/insertNewGroup",
					type : "POST",
					dataType : "JSON",
					data : {"emplyrSn" : emplyrSn, "groupNm" : groupNm, "useAt" : "Y"},
					success:function(result){
						if(result == "S"){
							$('.next_modal').show();
							mygroup();
						} else {
							alert("새 모임 만들기 중 오류가 발생하였습니다.(ajax성공)");
						}
					},
					error:function(e){
						alert("새 모임 만들기 중 오류가 발생하였습니다.(ajax실패)");
					}
				})
			};

			// 다음버튼 활성화/비활성화
			function nextBtn(){				
				var input = document.getElementById('input_group').value;
				var nextBtn = document.getElementById('void_btn');

				if(input.length > 0){
					nextBtn.disabled = false;
					if(input.length > 15){
						alert('모임명은 15글자를 초과할 수 없습니다.')
					}
				} else {
					nextBtn.disabled = true;
				}
			};

			// 사용자마다 내 그룹을 찾아서 메뉴에 추가하여 보여줘야함
			function mygroup(data){
				var emplyrSn = $('#emplyrSn').val();
				
				$.ajax({
					url : "/selectMyGroup",
					type : "POST",
					dataType : "JSON", //"JSON"
					data : {"emplyrSn" : emplyrSn},
					success:function(result){
						if(result.length > 0){
							// 조회된 메뉴 나열
							var content = "";

							for(var i=0; i<result.length; i++){
								content += "<li id='add_li_"+i+"' class='add_li'><div class='tree_item'> "+result[i][1]+"</div></li>";
							}

							$('#sub_list').html(content);      // 조회된 사진 리스트
							
						} else if(result.Status == "F"){
							alert("내 그룹 불러오는 도중 오류가 발생하였습니다.");
						}
					},
					error:function(e){
						alert("내 그룹 불러오는 도중 오류가 발생하였습니다.(ajax에러)");
					}
				})
			};

			// 각 그룹 오픈
			$(document).on("click",".add_li", function(){
				var id_check = $(this).attr("id");
				var idNum = id_check.substr(7);
				var emplyrSn = $('#emplyrSn').val();

				var data = {
					"emplyrSn"	: emplyrSn,
					"num"		: idNum
				}
				// 내가 클릭한 그룹의 정보를 갖고와야 함.				
				$.ajax({
					url : "/selectedGouprSn",
					type : "POST",
					dataType : "JSON", //"JSON"
					data : data,
					success:function(result){
						document.getElementById('groupSn').value = result.groupSn;
						document.getElementById('groupNm').value = result.groupNm;
						document.getElementById('emplyrNm').value = result.emplyrNm;
						document.getElementById('emplyrId').value = result.emplyrId;
						openMenu('group');
					},
					error:function(e){
						alert("그룹의 일련번호 조회 도중 오류가 발생하였습니다.(ajax에러)");
					}
				})
			})
		</script>
	</head>