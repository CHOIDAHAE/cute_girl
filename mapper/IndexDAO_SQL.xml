<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IndexDAO">

	<select id="selectFileVolume">
		SELECT
            NVL(CEIL(SUM(FILE_MG)/1000),0) FILE_MG
		FROM TCM_ATCHMNFL_DETAIL
		WHERE LAST_UPDUSR_SN = #{emplyrSn}
	</select>

	<!-- 첨부파일 일련번호 찾아오기 -->
	<select id="selectFileSn">
		SELECT /*+ INDEX_DESC(PK_TCM_ATCH_FILE ATCHMNFL_SN) */
			LPAD(NVL(MAX(ATCHMNFL_SN)+1, 1), 5, 0) FILE_SN
		FROM
			TCM_ATCHMNFL
	</select>

	<!-- 첨부파일 등록 -->
	<insert id="insertAtchFile">
		INSERT INTO TCM_ATCHMNFL
		(
			ATCHMNFL_SN
			, USE_AT
			, FRST_REGIST_DT
			, FRST_REGISTER_SN
			, LAST_UPDT_DT
			, LAST_UPDUSR_SN
		)
		VALUES
		(
			#{fileSn}
			, 'Y'
			, SYSDATE
			, #{emplyrSn}
			, SYSDATE
			, #{emplyrSn}
		)
	</insert>

	<insert id="insertAtchFileDtl">
		INSERT INTO TCM_ATCHMNFL_DETAIL
		(
			ATCHMNFL_SN
			, FILE_SN
			, FILE_STRE_COURS_NM
			, ORGINL_FILE_NM
			, FILE_NM
			, FILE_EXTSN_NM
			, FILE_MG
			, DOWN_CO
			, FRST_REGISTER_SN
			, FRST_REGIST_DT
			, LAST_UPDUSR_SN
			, LAST_UPDT_DT
		)
		VALUES
		(
			#{fileSn}
			, #{fileSn}
			, #{filePath}
			, #{orgFileNm}
			, #{fileNm}
			, #{fileExtsnNm}
			, #{fileSize}
			, 0
			, #{emplyrSn}
			, SYSDATE
			, #{emplyrSn}
			, SYSDATE
		)
	</insert>

	<!--첨부파일 목록 조회-->
	<select id="selectFileList">
		SELECT
			tad.FILE_STRE_COURS_NM
			, tad.ORGINL_FILE_NM
			, tad.FILE_NM
			, tad.FILE_EXTSN_NM
			, tad.FILE_MG
			, tad.DOWN_CO
			, tad.FRST_REGIST_DT
			, tad.FRST_REGISTER_SN 
		FROM
			TCM_ATCHMNFL ta
			, TCM_ATCHMNFL_DETAIL tad
		WHERE
			TA.ATCHMNFL_SN = TAD.ATCHMNFL_SN
			AND TA.USE_AT = 'Y'
			AND TA.FRST_REGISTER_SN = #{emplyrSn}
	</select>
</mapper>