<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IndexDAO">

	<select id="selectFileVolume">
		SELECT
            NVL(CEIL(SUM(FILE_MG)/1000),0) FILE_MG
		FROM TCM_ATCHMNFL_DETAIL
		WHERE LAST_UPDUSR_SN = #{emplyrSn}
	</select>

	<!-- 첨부파일 일련번호 찾아오기 -->
	<select id="selectFileSn">
		SELECT
			TO_NUMBER(NVL(MAX(ATCHMNFL_SN), TO_CHAR(SYSDATE, 'YYYYMMDD') || '00000')) + 1 FILE_SN
		FROM
			TCM_ATCHMNFL
	</select>

	<!-- 첨부파일 등록 -->
	<insert id="insertAtchFile">
		INSERT INTO TCM_ATCHMNFL
		(
			ATCHMNFL_SN
			, USE_AT
			, FRST_REGIST_DT
			, FRST_REGISTER_SN
			, LAST_UPDT_DT
			, LAST_UPDUSR_SN
		)
		VALUES
		(
			#{fileSn}
			, 'Y'
			, SYSDATE
			, #{emplyrSn}
			, SYSDATE
			, #{emplyrSn}
		)
	</insert>

	<insert id="insertAtchFileDtl">
		INSERT INTO TCM_ATCHMNFL_DETAIL
		(
			ATCHMNFL_SN
			, FILE_SN
			, FILE_STRE_COURS_NM
			, ORGINL_FILE_NM
			, FILE_NM
			, FILE_EXTSN_NM
			, FILE_MG
			, DOWN_CO
			, FRST_REGISTER_SN
			, FRST_REGIST_DT
			, LAST_UPDUSR_SN
			, LAST_UPDT_DT
		)
		VALUES
		(
			#{fileSn}
			, #{fileSn}
			, #{filePath}
			, #{orgFileNm}
			, #{fileNm}
			, #{fileExtsnNm}
			, #{fileSize}
			, 0
			, #{emplyrSn}
			, SYSDATE
			, #{emplyrSn}
			, SYSDATE
		)
	</insert>

	<!--첨부파일 목록 조회-->
	<select id="selectFileList">
		SELECT
			tad.FILE_STRE_COURS_NM
			, tad.ORGINL_FILE_NM
			, tad.FILE_NM
			, tad.FILE_EXTSN_NM
			, tad.FILE_MG
			, tad.DOWN_CO
			, tad.FRST_REGIST_DT
			, tad.FRST_REGISTER_SN 
			, tad.ATCHMNFL_SN
			, tad.FILE_SN
		FROM
			TCM_ATCHMNFL ta
			, TCM_ATCHMNFL_DETAIL tad
		WHERE
			TA.ATCHMNFL_SN = TAD.ATCHMNFL_SN
			AND TA.USE_AT = 'Y'
			AND TA.FRST_REGISTER_SN = #{emplyrSn}
	</select>

	<!--첨부파일 상세정보 조회-->
	<select id="selectFileDtlData">
		SELECT
			FILE_NM
			, FILE_STRE_COURS_NM 
			, FILE_EXTSN_NM 
			, FILE_MG 
			, DOWN_CO 
		FROM TCM_ATCHMNFL_DETAIL TAD
		WHERE
			ATCHMNFL_SN  = #{AtchfileSn}
			AND FILE_SN  = #{fileSn}
	</select>

	<!-- 파일 휴지통으로 이동 / 복원 -->
	<update id="updateFileUseAt">
		UPDATE TCM_ATCHMNFL
		SET
			USE_AT = #{useAt},
			LAST_UPDT_DT = SYSDATE,
			LAST_UPDUSR_SN = #{emplyrSn}
		WHERE 
			ATCHMNFL_SN = #{AtchfileSn}
	</update>
</mapper>